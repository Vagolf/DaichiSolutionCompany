<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Warranty Details</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- (ถ้าไม่ได้ใช้ Swiper/Flickity ในหน้านี้ เอาออกได้) -->
    <link rel="stylesheet" href="https://unpkg.com/swiper@9/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
</head>

<body>
    <div id="navbar" class="sticky-top"></div>

    <main class="warranty-wrap">
        <div class="w-details-head">
            <a id="backLink" class="w-back" href="warranty-check.html">← กลับ</a>
            <h1 class="w-title">รายละเอียดการรับประกัน</h1>
            <div class="w-sub" id="serialTitle">Serial: -</div>
        </div>

        <div id="detailsAlert"></div>

        <section class="w-card">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <div class="w-card-title">ข้อมูลสินค้า</div>
                <span id="statusBadge" class="badge w-badge">-</span>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="w-field">
                        <div class="w-field-label">ชื่อสินค้า</div>
                        <div class="w-field-value" id="productName">-</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="w-field">
                        <div class="w-field-label">รุ่น</div>
                        <div class="w-field-value" id="productModel">-</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="w-field">
                        <div class="w-field-label">วันที่ซื้อ</div>
                        <div class="w-field-value" id="purchaseDate">-</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="w-field">
                        <div class="w-field-label">วันเริ่มรับประกัน</div>
                        <div class="w-field-value" id="wStart">-</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="w-field">
                        <div class="w-field-label">วันสิ้นสุดรับประกัน</div>
                        <div class="w-field-value" id="wEnd">-</div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="w-field">
                        <div class="w-field-label">หมายเหตุ</div>
                        <div class="w-field-value" id="notes">-</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="footer"></div>

    <script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>

    <!-- Navbar and Footer -->
    <script src="../js/navbar.js"></script>
    <script src="../js/footer.js"></script>
    <script>
        const API_DETAIL = "api/warranty_detail.php";

        const backLink = document.getElementById("backLink");
        backLink.addEventListener("click", (e) => {
            e.preventDefault();
            const returnHref = sessionStorage.getItem("warranty_return_href");
            // ถ้ามีหน้าต้นทาง ให้กลับไปหน้าต้นทางนั้นเลย
            if (returnHref) {
                window.location.href = returnHref;
            } else if (history.length > 1) {
                history.back();
            } else {
                window.location.href = "warranty-check.html";
            }
        });

        const qs = new URLSearchParams(location.search);
        const serial = (qs.get("serial") || "").trim();

        const serialTitle = document.getElementById("serialTitle");
        const detailsAlert = document.getElementById("detailsAlert");

        const el = (id) => document.getElementById(id);

        function showAlert(type, msg) {
            detailsAlert.innerHTML = `<div class="alert alert-${type} w-alert">${msg}</div>`;
        }

        function setBadge(active) {
            const b = el("statusBadge");
            b.classList.remove("w-badge-active", "w-badge-expired");
            if (active) {
                b.classList.add("w-badge-active");
                b.textContent = "อยู่ในการรับประกัน";
            } else {
                b.classList.add("w-badge-expired");
                b.textContent = "หมดประกัน";
            }
        }

        async function load() {
            if (!serial) {
                showAlert("warning", "ไม่พบ Serial ในลิงก์ กรุณากลับไปหน้าเช็คใหม่");
                return;
            }

            serialTitle.textContent = `Serial: ${serial}`;

            try {
                const url = new URL(API_DETAIL, window.location.href);
                url.searchParams.set("serial", serial);

                const res = await fetch(url.toString(), { method: "GET" });
                const data = await res.json();

                if (!data.ok) {
                    showAlert("danger", data.message || "เกิดข้อผิดพลาด");
                    return;
                }
                if (!data.found) {
                    showAlert("danger", data.message || "ไม่พบข้อมูลสินค้า");
                    return;
                }

                const d = data.data;

                el("productName").textContent = d.product_name || "-";
                const model = (d.model ?? "").trim();
                el("productModel").textContent = model || "-";

                el("purchaseDate").textContent = d.purchase_date || "-";
                el("wStart").textContent = d.warranty_start || "-";
                el("wEnd").textContent = d.warranty_end || "-";
                el("notes").textContent = d.notes || "-";

                setBadge(!!d.in_warranty);

            } catch (err) {
                console.error(err);
                showAlert("danger", "โหลดข้อมูลไม่ได้ กรุณาลองใหม่");
            }
        }

        load();
    </script>
</body>

</html>